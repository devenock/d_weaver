<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Whiteboard – DiagramGen</title>
  <link rel="stylesheet" href="/static/css/site.css" />
  <script src="/static/js/theme.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="min-h-screen bg-background">
  <nav id="whiteboard-nav" class="border-b border-border bg-background/95 sticky top-0 z-50 w-full">
    <div class="w-full px-4 h-16 flex items-center justify-between">
      <a href="/" class="text-xl font-bold bg-clip-text text-transparent" style="background: linear-gradient(to right, hsl(var(--primary)), hsl(var(--primary) / 0.8)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">DiagramGen</a>
      <div class="flex items-center gap-4">
        <button type="button" class="theme-toggle btn btn-ghost btn-sm" aria-label="Toggle theme"></button>
        <a href="/dashboard" class="btn btn-ghost btn-sm">Dashboard</a>
      </div>
    </div>
  </nav>
  <div id="whiteboard-embed-bar" class="hidden border-b border-border bg-muted/30 px-3 py-2 flex items-center gap-2" style="display: none;">
    <a href="/dashboard" target="_parent" class="text-sm text-primary hover:underline">← Dashboard</a>
  </div>

  <main class="container mx-auto px-4 py-6" style="max-width: 90rem;">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">Whiteboard</h1>
      <div class="flex items-center gap-2">
        <button type="button" id="btn-save" class="btn btn-primary btn-sm">Save</button>
        <button type="button" id="btn-png" class="btn btn-outline btn-sm">Export PNG</button>
        <button type="button" id="btn-pdf" class="btn btn-outline btn-sm">Export PDF</button>
      </div>
    </div>

    <div class="rounded-xl border border-border bg-card p-4 shadow-sm">
      <!-- Toolbar -->
      <div class="flex flex-wrap items-center gap-2 mb-4">
        <button type="button" id="btn-undo" class="btn btn-outline btn-sm" title="Undo">↶ Undo</button>
        <button type="button" id="btn-redo" class="btn btn-outline btn-sm" title="Redo">↷ Redo</button>
        <span class="w-px h-6 bg-border mx-1"></span>
        <button type="button" data-tool="select" class="btn btn-primary btn-sm tool-btn">Select</button>
        <button type="button" data-tool="draw" class="btn btn-outline btn-sm tool-btn">Draw</button>
        <button type="button" data-tool="eraser" class="btn btn-outline btn-sm tool-btn">Eraser</button>
        <button type="button" data-tool="rectangle" class="btn btn-outline btn-sm tool-btn">Rectangle</button>
        <button type="button" data-tool="circle" class="btn btn-outline btn-sm tool-btn">Circle</button>
        <button type="button" data-tool="line" class="btn btn-outline btn-sm tool-btn">Line</button>
        <button type="button" data-tool="triangle" class="btn btn-outline btn-sm tool-btn">Triangle</button>
        <button type="button" data-tool="hexagon" class="btn btn-outline btn-sm tool-btn">Hexagon</button>
        <button type="button" data-tool="star" class="btn btn-outline btn-sm tool-btn">Star</button>
        <button type="button" data-tool="text" class="btn btn-outline btn-sm tool-btn">Text</button>
        <label class="flex items-center gap-1 ml-2 text-sm text-muted-foreground">
          Color:
          <input type="color" id="stroke-color" value="#000000" class="w-8 h-8 rounded border border-border cursor-pointer" />
        </label>
        <button type="button" id="btn-clear" class="btn btn-outline btn-sm ml-auto">Clear</button>
      </div>

      <!-- Canvas -->
      <div class="border border-border rounded-lg overflow-auto bg-white relative" style="max-height: 70vh;">
        <canvas id="wb-canvas" width="1200" height="700"></canvas>
        <div class="absolute bottom-2 right-2 text-xs text-muted-foreground bg-background/80 px-2 py-1 rounded">Drag & drop images</div>
      </div>
    </div>

    <p id="wb-error" class="hidden mt-4 alert-error" role="alert"></p>
    <details class="mt-4 rounded-xl border border-border bg-card p-4 shadow-sm">
      <summary class="cursor-pointer text-sm font-medium">Embed</summary>
      <p class="mt-2 text-xs text-muted-foreground">After saving, use this link to share or embed:</p>
      <code id="wb-embed-url" class="block mt-2 p-2 rounded bg-muted/50 text-xs break-all"></code>
      <button type="button" id="btn-copy-embed" class="btn btn-outline btn-sm mt-2">Copy link</button>
    </details>
  </main>

  <script>
(function() {
  if (new URLSearchParams(window.location.search).get('embed') === '1') {
    var nav = document.getElementById('whiteboard-nav');
    var bar = document.getElementById('whiteboard-embed-bar');
    if (nav) nav.style.display = 'none';
    if (bar) bar.style.display = 'flex';
  }
})();
  </script>
  <script>
(function() {
  var API = '/api/v1';
  var canvasEl = document.getElementById('wb-canvas');
  var strokeColor = '#000000';
  var history = [];
  var historyStep = 0;
  var currentId = null;

  var canvas = new fabric.Canvas('wb-canvas', { backgroundColor: '#ffffff' });
  canvas.isDrawingMode = false;
  canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
  canvas.freeDrawingBrush.color = strokeColor;
  canvas.freeDrawingBrush.width = 2;

  function pushState() {
    var json = JSON.stringify(canvas.toJSON());
    history = history.slice(0, historyStep + 1);
    history.push(json);
    historyStep = history.length - 1;
  }

  canvas.on('object:added', pushState);
  canvas.on('object:modified', pushState);
  canvas.on('object:removed', pushState);

  history.push(JSON.stringify(canvas.toJSON()));

  document.getElementById('stroke-color').addEventListener('input', function(e) {
    strokeColor = e.target.value;
    if (canvas.freeDrawingBrush) canvas.freeDrawingBrush.color = strokeColor;
  });

  function setTool(tool) {
    document.querySelectorAll('.tool-btn').forEach(function(b) {
      b.classList.toggle('btn-primary', b.getAttribute('data-tool') === tool);
      b.classList.toggle('btn-outline', b.getAttribute('data-tool') !== tool);
    });
    canvas.isDrawingMode = (tool === 'draw' || tool === 'eraser');
    if (canvas.freeDrawingBrush) {
      if (tool === 'eraser') {
        canvas.freeDrawingBrush.color = '#ffffff';
        canvas.freeDrawingBrush.width = 20;
      } else {
        canvas.freeDrawingBrush.color = strokeColor;
        canvas.freeDrawingBrush.width = 2;
      }
    }
    if (tool === 'select') return;
    if (tool === 'rectangle') {
      var rect = new fabric.Rect({ left: 100, top: 100, fill: 'transparent', stroke: strokeColor, strokeWidth: 2, width: 150, height: 100 });
      canvas.add(rect);
      canvas.setActiveObject(rect);
    } else if (tool === 'circle') {
      var circle = new fabric.Circle({ left: 100, top: 100, fill: 'transparent', stroke: strokeColor, strokeWidth: 2, radius: 60 });
      canvas.add(circle);
      canvas.setActiveObject(circle);
    } else if (tool === 'line') {
      var line = new fabric.Line([50, 100, 200, 100], { stroke: strokeColor, strokeWidth: 2 });
      canvas.add(line);
      canvas.setActiveObject(line);
    } else if (tool === 'triangle') {
      var tri = new fabric.Triangle({ left: 100, top: 100, fill: 'transparent', stroke: strokeColor, strokeWidth: 2, width: 100, height: 100 });
      canvas.add(tri);
      canvas.setActiveObject(tri);
    } else if (tool === 'hexagon') {
      var pts = [];
      for (var i = 0; i < 6; i++) {
        var a = (i * Math.PI / 3) - Math.PI / 6;
        pts.push({ x: 50 + 50 * Math.cos(a), y: 50 + 50 * Math.sin(a) });
      }
      var poly = new fabric.Polygon(pts, { left: 100, top: 100, fill: 'transparent', stroke: strokeColor, strokeWidth: 2 });
      canvas.add(poly);
      canvas.setActiveObject(poly);
    } else if (tool === 'star') {
      var pts = [];
      for (var i = 0; i < 10; i++) {
        var r = (i % 2 === 0) ? 50 : 25;
        var a = (i * Math.PI / 5) - Math.PI / 2;
        pts.push({ x: 50 + r * Math.cos(a), y: 50 + r * Math.sin(a) });
      }
      var star = new fabric.Polygon(pts, { left: 100, top: 100, fill: 'transparent', stroke: strokeColor, strokeWidth: 2 });
      canvas.add(star);
      canvas.setActiveObject(star);
    } else if (tool === 'text') {
      var text = new fabric.IText('Double click to edit', { left: 100, top: 100, fill: strokeColor, fontSize: 20 });
      canvas.add(text);
      canvas.setActiveObject(text);
    }
    canvas.renderAll();
  }

  document.querySelectorAll('.tool-btn').forEach(function(b) {
    b.addEventListener('click', function() { setTool(b.getAttribute('data-tool')); });
  });

  document.getElementById('btn-undo').addEventListener('click', function() {
    if (historyStep <= 0) return;
    historyStep--;
    canvas.loadFromJSON(history[historyStep], function() { canvas.renderAll(); });
  });

  document.getElementById('btn-redo').addEventListener('click', function() {
    if (historyStep >= history.length - 1) return;
    historyStep++;
    canvas.loadFromJSON(history[historyStep], function() { canvas.renderAll(); });
  });

  document.getElementById('btn-clear').addEventListener('click', function() {
    canvas.clear();
    canvas.backgroundColor = '#ffffff';
    canvas.renderAll();
    history = [JSON.stringify(canvas.toJSON())];
    historyStep = 0;
  });

  function showError(msg) {
    var el = document.getElementById('wb-error');
    el.textContent = msg || '';
    el.classList.toggle('hidden', !msg);
  }

  function getBoundingBox() {
    var objs = canvas.getObjects();
    if (objs.length === 0) return null;
    var minX = 1/0, minY = 1/0, maxX = -1/0, maxY = -1/0;
    objs.forEach(function(obj) {
      var b = obj.getBoundingRect();
      minX = Math.min(minX, b.left);
      minY = Math.min(minY, b.top);
      maxX = Math.max(maxX, b.left + b.width);
      maxY = Math.max(maxY, b.top + b.height);
    });
    var pad = 20;
    return { left: minX - pad, top: minY - pad, width: maxX - minX + pad * 2, height: maxY - minY + pad * 2 };
  }

  document.getElementById('btn-save').addEventListener('click', function() {
    var content = JSON.stringify(canvas.toJSON());
    var title = 'Whiteboard ' + new Date().toLocaleDateString();
    var body = { title: title, content: content, diagram_type: 'whiteboard', is_public: false };
    var url = currentId ? API + '/diagrams/' + currentId : API + '/diagrams';
    var method = currentId ? 'PUT' : 'POST';
    fetch(url, {
      method: method,
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    })
      .then(function(r) {
        if (!r.ok) return r.json().then(function(j) { throw new Error(j.message || 'Save failed'); });
        return r.json();
      })
      .then(function(json) {
        var d = json.data || json;
        if (d.id) currentId = d.id;
        showError('');
        if (window.history && window.history.replaceState) window.history.replaceState({}, '', '/whiteboard?id=' + (d.id || currentId));
        var embedEl = document.getElementById('wb-embed-url');
        if (embedEl) embedEl.textContent = window.location.origin + '/whiteboard?id=' + (d.id || currentId);
        if (d.id) uploadWhiteboardImage(d.id);
      })
      .catch(function(e) { showError(e.message || 'Save failed'); });
  });

  function uploadWhiteboardImage(id) {
    var box = getBoundingBox();
    if (!box) return;
    var dataUrl = canvas.toDataURL({ format: 'png', quality: 1, multiplier: 2, left: box.left, top: box.top, width: box.width, height: box.height });
    fetch(dataUrl).then(function(r) { return r.blob(); }).then(function(blob) {
      var fd = new FormData();
      fd.append('file', blob, 'preview.png');
      fetch(API + '/diagrams/' + id + '/image', { method: 'POST', credentials: 'include', body: fd }).catch(function() {});
    }).catch(function() {});
  }

  function exportPng() {
    var box = getBoundingBox();
    if (!box) { showError('Canvas is empty'); return; }
    var dataUrl = canvas.toDataURL({ format: 'png', quality: 1, multiplier: 2, left: box.left, top: box.top, width: box.width, height: box.height });
    var a = document.createElement('a');
    a.href = dataUrl;
    a.download = 'whiteboard-' + Date.now() + '.png';
    a.click();
  }

  function exportPdf() {
    var box = getBoundingBox();
    if (!box) { showError('Canvas is empty'); return; }
    var dataUrl = canvas.toDataURL({ format: 'png', quality: 1, multiplier: 2, left: box.left, top: box.top, width: box.width, height: box.height });
    var JsPDF = window.jspdf.jsPDF;
    var pdf = new JsPDF({ orientation: box.width > box.height ? 'landscape' : 'portrait', unit: 'px', format: [box.width, box.height] });
    pdf.addImage(dataUrl, 'PNG', 0, 0, box.width, box.height);
    pdf.save('whiteboard-' + Date.now() + '.pdf');
  }

  document.getElementById('btn-png').addEventListener('click', exportPng);
  document.getElementById('btn-pdf').addEventListener('click', exportPdf);

  // Drag & drop image
  canvasEl.addEventListener('dragover', function(e) { e.preventDefault(); });
  canvasEl.addEventListener('drop', function(e) {
    e.preventDefault();
    var file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    if (!file || !file.type.startsWith('image/')) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
      var img = new Image();
      img.onload = function() {
        var fImg = new fabric.Image(img, { left: 100, top: 100, scaleX: 0.5, scaleY: 0.5 });
        canvas.add(fImg);
        canvas.setActiveObject(fImg);
        canvas.renderAll();
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });

  // Load diagram
  var params = new URLSearchParams(window.location.search);
  var id = params.get('id') || params.get('diagramId');
  if (id) {
    fetch(API + '/diagrams/' + id, { credentials: 'include' })
      .then(function(r) {
        if (!r.ok) throw new Error('Failed to load');
        return r.json();
      })
      .then(function(json) {
        var d = json.data || json;
        if (d.content && d.content !== 'whiteboard') {
          try {
            var data = typeof d.content === 'string' ? JSON.parse(d.content) : d.content;
            canvas.loadFromJSON(data, function() {
              canvas.renderAll();
              history = [JSON.stringify(canvas.toJSON())];
              historyStep = 0;
            });
          } catch (_) {}
        }
        currentId = d.id;
        var embedEl = document.getElementById('wb-embed-url');
        if (embedEl) embedEl.textContent = window.location.origin + '/whiteboard?id=' + d.id;
      })
      .catch(function() { showError('Could not load whiteboard.'); });
  }
  document.getElementById('btn-copy-embed').addEventListener('click', function() {
    var el = document.getElementById('wb-embed-url');
    if (el && el.textContent) navigator.clipboard.writeText(el.textContent);
  });
})();
  </script>
</body>
</html>
